#!/bin/bash

# Resource Scheduler - Server Management Script
# Usage: ./start [start|restart|stop]

# Function to display usage
show_usage() {
    echo "Resource Scheduler Server Management"
    echo ""
    echo "Usage:"
    echo "  ./start start     - Start both backend and frontend servers"
    echo "  ./start restart   - Restart both servers"
    echo "  ./start stop      - Stop both servers"
    echo ""
    echo "Or simply type:"
    echo "  start             - Start servers"
    echo "  restart           - Restart servers"
}

# Function to check if servers are running
check_servers() {
    local backend_running=$(pgrep -f "node index.js" | wc -l)
    local frontend_running=$(pgrep -f "vite" | wc -l)
    
    if [ $backend_running -gt 0 ] || [ $frontend_running -gt 0 ]; then
        return 0  # Servers are running
    else
        return 1  # No servers running
    fi
}

# Function to start servers
start_servers() {
    echo "ğŸš€ Starting Resource Scheduler servers..."
    
    # Check if servers are already running
    if check_servers; then
        echo "âš ï¸  Servers are already running!"
        echo "Use 'restart' to restart them or 'stop' to stop them first."
        return 1
    fi
    
    # Install dependencies if node_modules don't exist
    if [ ! -d "node_modules" ]; then
        echo "ğŸ“¦ Installing dependencies..."
        npm run install:all
    fi
    
    # Start servers
    echo "ğŸ”§ Starting backend and frontend servers..."
    npm start
    
    echo ""
    echo "âœ… Servers started successfully!"
    echo "ğŸŒ Frontend: http://localhost:5173"
    echo "ğŸ”Œ Backend: http://localhost:3000"
    echo ""
    echo "Press Ctrl+C to stop the servers"
}

# Function to restart servers
restart_servers() {
    echo "ğŸ”„ Restarting Resource Scheduler servers..."
    
    # Stop servers first
    stop_servers
    
    # Wait a moment
    sleep 2
    
    # Start servers
    start_servers
}

# Function to stop servers
stop_servers() {
    echo "ğŸ›‘ Stopping servers..."
    npm run stop
    echo "âœ… Servers stopped"
}

# Main script logic
case "${1:-start}" in
    "start")
        start_servers
        ;;
    "restart")
        restart_servers
        ;;
    "stop")
        stop_servers
        ;;
    "help"|"-h"|"--help")
        show_usage
        ;;
    *)
        echo "âŒ Unknown command: $1"
        show_usage
        exit 1
        ;;
esac 